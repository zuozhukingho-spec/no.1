<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H.K.P.C.æ‰§æ³•å®˜è€ƒæ ¸</title>
    <style>
        /* --- 1. è¦–è¦ºæ ¸å¿ƒ --- */
        :root {
            --police-dark: #0a2342;
            --police-blue: #0056b3;
            --text-main: #1a1a1a;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 8px 30px rgba(10, 35, 66, 0.2);
            --border: #cadae8;
        }

        body {
            margin: 0; padding: 0;
            background-color: #f4f7fa;
            background-image: 
                linear-gradient(rgba(10, 35, 66, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(10, 35, 66, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            position: relative;
        }

        /* --- 2. é ‚éƒ¨ç‹€æ…‹æ¬„ --- */
        .top-hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: var(--police-dark); color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; box-sizing: border-box; z-index: 100;
        }
        .progress-module {
            display: flex; align-items: center; gap: 15px;
            background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 4px;
        }
        .progress-track { width: 200px; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #00d2ff; transition: width 0.5s; }

        /* --- 3. äººç‰©ç«‹ç¹ªå±¤ --- */
        #character-stage {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 10; pointer-events: none; overflow: hidden;
            transition: opacity 0.5s;
        }
        .character-img {
            position: absolute; left: 50%; bottom: 0;
            height: 85vh; width: auto; max-width: 80vw;
            transform: translateX(-50%) translateZ(0);
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5));
            animation: float-only 6s ease-in-out infinite; 
            transition: opacity 0.3s ease-in-out; 
            opacity: 0;
        }
        @keyframes float-only {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* --- 4. å°è©±æ¡† --- */
        #dialogue-layer {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 1100px; height: 240px; z-index: 50;
            pointer-events: auto; cursor: pointer;
            transition: opacity 0.5s;
        }
        .dialogue-box {
            width: 100%; height: 100%; background: var(--glass);
            border: 1px solid var(--border); border-top: 4px solid var(--police-dark);
            border-radius: 8px; padding: 50px 40px 30px 40px;
            box-sizing: border-box; box-shadow: var(--shadow);
            backdrop-filter: blur(15px); display: flex; flex-direction: column;
        }
        .name-tag {
            position: absolute; top: -22px; left: 40px;
            background: var(--police-dark); color: white; padding: 8px 35px;
            font-size: 1.1rem; border-radius: 4px; display: flex; align-items: center; gap: 10px;
        }
        .name-tag::before { content: ''; display: block; width: 8px; height: 8px; background: #00d2ff; border-radius: 50%; }
        .text-content { font-size: 1.2rem; line-height: 1.6; color: var(--text-main); font-weight: 500; flex: 1; }
        .next-indicator { align-self: flex-end; color: var(--police-blue); font-weight: bold; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(5px); } }

        /* --- 5. éŠæˆ²è€ƒæ ¸æ¨¡å¼å®¹å™¨ --- */
        #game-stage-wrapper {
            position: absolute;
            top: 55%; left: 50%;
            transform: translate(-50%, -50%);
            width: 95%; max-width: 480px;
            height: auto;
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .game-header-area {
            position: relative; height: 140px; width: 100%;
            display: flex; align-items: flex-end; margin-bottom: -5px;
        }
        .mini-char-container {
            position: absolute; right: 0; bottom: 0;
            width: 45%; height: 100%; z-index: 2;
        }
        .mini-char-img {
            width: 100%; height: 100%;
            object-fit: contain; object-position: bottom right;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));
        }
        .mini-dialogue-box {
            position: relative; width: 60%;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--police-dark);
            border-radius: 12px 12px 0 12px;
            padding: 12px; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 0.9rem; line-height: 1.4; color: #333;
            z-index: 1; transition: all 0.3s;
        }
        .mini-dialogue-box::after {
            content: ''; position: absolute; bottom: -8px; right: -8px;
            border-width: 10px 10px 0; border-style: solid;
            border-color: var(--police-dark) transparent;
            display: block; width: 0;
        }
        
        /* èª¿æ•´éŠæˆ²å®¹å™¨é«˜åº¦ä»¥é©æ‡‰ç§»å‹•ç«¯ */
        .game-frame-container {
            width: 100%; 
            height: 55vh; /* ç¨å¾®å¢åŠ é«˜åº¦ */
            max-height: 600px;
            border: 4px solid var(--police-dark);
            border-radius: 10px; overflow: hidden;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative; z-index: 10;
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* éŠæˆ²é–‹å§‹/é‡è©¦é®ç½© */
        #game-start-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 20;
        }
        .btn-game-start {
            background: #00d2ff; color: #0a2342;
            border: 2px solid #fff; padding: 15px 30px;
            font-size: 1.2rem; font-weight: bold;
            border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 20px #00d2ff;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- å…¨å±€é®ç½©å±¤ --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 1000; display: flex;
            justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s;
        }
        .btn-start {
            margin-top: 30px; padding: 15px 40px; background: var(--police-dark);
            color: white; border: none; border-radius: 4px; font-size: 1.2rem; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="top-hud">
        <div class="logo-area"><span>ğŸ›¡ï¸</span> <span>H.K.P.C.è€ƒæ ¸ç³»çµ±</span></div>
        <div class="progress-module">
            <span style="font-size: 0.85rem;">é€²åº¦</span>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
            <span id="progress-text">0%</span>
        </div>
    </div>

    <div id="vn-layers">
        <div id="character-stage">
            <img id="char-img" src="" alt="Character" class="character-img">
        </div>

        <div id="dialogue-layer" onclick="nextStep()">
            <div class="dialogue-box">
                <div class="name-tag" id="speaker-name">SYSTEM</div>
                <div class="text-content" id="text-box">ç­‰å¾…éˆæ¥...</div>
                <div class="next-indicator">é»æ“Šç¹¼çºŒ â–¶</div>
            </div>
        </div>
    </div>

    <div id="game-stage-wrapper">
        <div class="game-header-area">
            <div class="mini-dialogue-box" id="mini-dialogue-content">
                <b id="mini-speaker-name">è¾è§:</b><br>
                <span id="mini-text">è¯·å‡†å¤‡å¥½ï¼Œè€ƒæ ¸å³å°†å¼€å§‹...</span>
            </div>
            <div class="mini-char-container">
                <img id="mini-char-img" src="" class="mini-char-img">
            </div>
        </div>
        <div class="game-frame-container">
            <div id="game-start-mask">
                <button id="btn-game-action" class="btn-game-start" onclick="triggerGameStart()">é–‹å§‹è€ƒæ ¸</button>
            </div>
            <iframe id="game-iframe"></iframe>
        </div>
    </div>

    <div id="start-overlay" class="overlay">
        <h1 style="color: var(--police-dark);">H.K.P.C.è€ƒæ ¸ç³»çµ±</h1>
        <button class="btn-start" onclick="initSystem()">é–‹å§‹éˆæ¥</button>
    </div>

    <script>
        // --- è³‡æºé…ç½® ---
        const IMG_NORMAL = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260204194356403.png";
        const IMG_RULES  = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260204193719993.png"; 
        const IMG_CIYING = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260205175449109.png";
        // ç¾½å²š & ç¾½æ™“
        const IMG_TWINS  = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260208214019535.png";

        // --- æ¸¸æˆ 1ï¼šåˆ‡è¥¿ç“œ æºä»£ç  (ä¿®å¤ç§»åŠ¨ç«¯è§¦æ§) ---
        const GAME1_SOURCE_CODE = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
body { margin: 0; background: #ffffff; color: #333; overflow: hidden; font-family: 'Microsoft YaHei', sans-serif; user-select: none; touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤æ‰‹åŠ¿ */ }
canvas { display: block; touch-action: none; cursor: crosshair; }
#ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 10px; z-index: 10; display:flex; flex-direction:column; box-sizing: border-box;}
.header-row { display: flex; justify-content: space-between; width: 100%; margin: 0 auto 10px; }
.combo-row { display: flex; justify-content: center; gap: 20px; width: 100%; }
.stat-box { background: rgba(240,240,240,0.9); padding: 5px 15px; border-radius: 20px; border: 2px solid #ddd; font-weight: bold; font-size:16px; white-space:nowrap; }
.combo-box { color: #d35400; border-color: #f39c12; transition: transform 0.1s; }
.combo-active { transform: scale(1.2); }
#flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; z-index: 5; transition: opacity 0.1s; }
#game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; background: rgba(255,255,255,0.95); padding: 20px 40px; border-radius: 10px; border: 3px solid #333; z-index: 100; text-align: center; }
</style>
</head>
<body>
<div id="flash"></div>
<div id="ui">
<div class="header-row"><div class="stat-box">Score: <span id="score">0</span></div><div class="stat-box"><span id="time">60</span>s</div><div class="stat-box" style="color:#f33" id="lives">â¤ï¸â¤ï¸â¤ï¸</div></div>
<div class="combo-row"><div class="stat-box combo-box" id="cbox">Combo: <span id="combo">0</span></div></div>
</div>
<div id="game-over"><h2 id="end-title">Game Over</h2></div>
<canvas id="c"></canvas>
<script>
const CFG={g:0.025,drag:0.998,time:60,safe:20,p1:[1,2],p2:[2,4],int:2200};
const cvs=document.getElementById('c'), ctx=cvs.getContext('2d');
let W,H; function resize(){W=cvs.width=window.innerWidth;H=cvs.height=window.innerHeight;} window.onresize=resize; resize();
const DATA={BAD:[{t:'æœ¨é©¬',c:'#e74c3c'},{t:'ç—…æ¯’',c:'#c0392b'},{t:'é’“é±¼',c:'#d35400'},{t:'å‹’ç´¢',c:'#2c3e50'}],GOOD:[{t:'é˜²ç«å¢™',c:'#27ae60'},{t:'VPN',c:'#16a085'},{t:'åŠ å¯†',c:'#1abc9c'}]};
let st={active:false,score:0,combo:0,maxC:0,lives:3,start:0,objs:[],parts:[],blade:[],phase:false,total:0,down:false};
window.addEventListener('message',e=>{if(e.data==='START_GAME')start();});
class Itm{constructor(d,tool){this.t=d.t;this.c=d.c;this.tool=tool;this.r=50;this.x=Math.random()*(W*0.8)+W*0.1;this.y=H+60;this.vx=(W/2-this.x+(Math.random()-0.5)*300)/((Math.sqrt(2*CFG.g*(this.y-H*0.35)))/CFG.g);this.vy=-Math.sqrt(2*CFG.g*(this.y-H*0.35));this.a=0;this.sa=(Math.random()-0.5)*0.05;}}
function start(){st={active:true,score:0,combo:0,maxC:0,lives:3,start:Date.now(),objs:[],parts:[],blade:[],phase:false,total:0,down:false};document.getElementById('game-over').style.display='none';loop();spawn();}
function spawn(){if(!st.active)return;let p=(Date.now()-st.start)/1000;let n=Math.floor(Math.random()*(CFG.p1[1]-CFG.p1[0]+1))+CFG.p1[0];if(p>=CFG.safe)n=Math.floor(Math.random()*(CFG.p2[1]-CFG.p2[0]+1))+CFG.p2[0];
for(let i=0;i<n;i++){let tool=p<CFG.safe?false:(Math.random()<0.15);let pool=tool?DATA.GOOD:DATA.BAD;if(!tool)st.total++;
setTimeout(()=>{if(st.active)st.objs.push(new Itm(pool[Math.floor(Math.random()*pool.length)],tool));},i*500);}
setTimeout(spawn,CFG.int);}
function end(win,r){st.active=false;document.getElementById('game-over').style.display='block';document.getElementById('end-title').innerText=win?'é˜²å¾¡æˆåŠŸ':'é˜²å¾¡å¤±è´¥';document.getElementById('end-title').style.color=win?'#27ae60':'#c0392b';
window.parent.postMessage({type:'GAME_OVER',win:win,reason:r,maxCombo:st.maxC,totalTargets:st.total},'*');}
function loop(){ctx.fillStyle='#fff';ctx.fillRect(0,0,W,H);if(!st.active)return;
let p=(Date.now()-st.start)/1000, left=Math.max(0,CFG.time-Math.floor(p));
document.getElementById('time').innerText=left;document.getElementById('score').innerText=st.score;document.getElementById('combo').innerText=st.combo;document.getElementById('lives').innerText='â¤ï¸'.repeat(st.lives);
if(st.combo>st.maxC)st.maxC=st.combo; if(st.combo>0)document.getElementById('cbox').classList.add('combo-active');else document.getElementById('cbox').classList.remove('combo-active');
if(p>=CFG.safe&&!st.phase){st.phase=true;window.parent.postMessage({type:'PHASE_CHANGE'},'*');}
if(left<=0)end(true,'æ—¶é—´åˆ°');
st.objs.forEach((o,i)=>{o.x+=o.vx;o.y+=o.vy;o.vy+=CFG.g;o.vx*=CFG.drag;o.a+=o.sa;
ctx.translate(o.x,o.y);ctx.rotate(o.a);ctx.beginPath();ctx.arc(0,0,o.r,0,6.28);ctx.fillStyle=o.c;ctx.fill();
ctx.fillStyle='#fff';ctx.font='bold 20px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(o.t,0,0);ctx.resetTransform();
if(o.y>H+100){if(!o.tool)hit(false,'æ¼æ‰æ”»å‡»');st.objs.splice(i,1);}});
if(st.blade.length>1){ctx.beginPath();st.blade.forEach((p,i)=>{if(i==0)ctx.moveTo(p.x,p.y);else ctx.lineTo(p.x,p.y);});ctx.strokeStyle='#00d2ff';ctx.lineWidth=5;ctx.stroke();}
if(st.blade.length>8)st.blade.shift();requestAnimationFrame(loop);}
function hit(good,r){if(good){st.score+=10;st.combo++;}else{st.lives--;st.combo=0;document.getElementById('flash').style.opacity=0.5;setTimeout(()=>document.getElementById('flash').style.opacity=0,100);if(st.lives<=0)end(false,r);}}

// --- ä¿®å¤éƒ¨åˆ†ï¼šæ­£ç¡®è·å– Canvas ç›¸å¯¹åæ ‡å¹¶ç»‘å®šåˆ° Canvas å…ƒç´  ---
function getPos(e) {
    const rect = cvs.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
        x: clientX - rect.left,
        y: clientY - rect.top
    };
}

// è§¦æ‘¸äº‹ä»¶ (ç§»åŠ¨ç«¯)
cvs.addEventListener('touchstart', e => {
    e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
    st.down = true;
    st.blade = [];
    const p = getPos(e);
    st.blade.push(p);
    check(p.x, p.y);
}, {passive: false});

cvs.addEventListener('touchmove', e => {
    e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
    if(st.down) {
        const p = getPos(e);
        st.blade.push(p);
        check(p.x, p.y);
    }
}, {passive: false});

cvs.addEventListener('touchend', e => {
    e.preventDefault();
    st.down = false;
});

// é¼ æ ‡äº‹ä»¶ (æ¡Œé¢ç«¯)
window.onmousedown=e=>{st.down=true;st.blade=[];};
window.onmousemove=e=>{
    if(st.down){
        st.blade.push({x:e.clientX,y:e.clientY});
        check(e.clientX,e.clientY);
    }
};
window.onmouseup=e=>st.down=false;

function check(x,y){
    st.objs.forEach((o,i)=>{
        if(Math.hypot(o.x-x,o.y-y)<o.r){
            st.objs.splice(i,1);
            if(o.tool)hit(false,'è¯¯ä¼¤å‹å†›');
            else hit(true);
        }
    });
}
<\/script></body></html>`;

        // --- æ¸¸æˆ 2ï¼šèŠ‚å¥é˜²å¾¡ æºä»£ç  (ä¿®å¤ç§»åŠ¨ç«¯å¸ƒå±€) ---
        const GAME2_SOURCE_CODE = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root{--bg:#f8f9fa;--text:#212529;--hl:#fab1a0;--act:#f1c40f;--red:#e74c3c;--blue:#3498db;--green:#2ecc71;}
        body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;user-select:none;overflow:hidden; box-sizing: border-box;}
        
        .hud{width:95%;max-width:800px;display:flex;justify-content:space-between;margin-bottom:10px;font-size:1.2rem;font-weight:800;color:#2c3e50; margin-top: 10px;}
        .status-bar{width:95%;max-width:800px;height:8px;background:#dfe6e9;border-radius:4px;margin-bottom:15px;overflow:hidden;flex-shrink: 0;}
        .status-fill{height:100%;width:0%;transition:width 0.1s linear;}
        .status-fill.prep{background:#636e72;} .status-fill.action{background:var(--red);width:100%;}
        
        /* æ ¸å¿ƒä¿®å¤ï¼šæ›´ç´§å‡‘çš„ Grid */
        .grid-container{
            display:grid;
            grid-template-columns:repeat(4,1fr);
            grid-template-rows:repeat(2,1fr);
            gap:10px;
            width:96%;
            max-width:900px;
            margin-bottom:15px;
            opacity:0.5;
            transition:opacity 0.2s;
            flex: 1; /* è‡ªé€‚åº”é«˜åº¦ */
            max-height: 400px; /* é™åˆ¶æœ€å¤§é«˜åº¦é˜²æ­¢æŒ¤å‡ºå±å¹• */
        }
        .grid-container.active{opacity:1;}
        
        .card{
            background:#fff;border:2px solid #e9ecef;border-radius:8px;
            display:flex;align-items:center;justify-content:center;
            text-align:center;padding:2px;
            box-shadow:0 2px 4px rgba(0,0,0,0.05);transition:transform 0.1s;
            font-size: 1rem;
            word-break: break-all;
        }
        .card.target{border:4px solid var(--act);transform:scale(1.02);background:#fffdf0;z-index:10;}
        .card.done{opacity:0.2;transform:scale(0.95);background:#ecf0f1;border-color:transparent;}
        .card.wrong{background:var(--red);color:#fff;} .card.rhythm-hit{transform:scale(0.95);border-color:#bdc3c7;}
        
        .controls{display:flex;gap:10px;width:96%;max-width:800px; margin-bottom: 10px; height: 60px; flex-shrink: 0;}
        .btn{flex:1;border:none;border-radius:10px;font-size:1rem;font-weight:bold;color:#fff;opacity:0.5;transition:0.2s; display: flex; align-items: center; justify-content: center;}
        .controls.unlocked .btn{opacity:1;cursor:pointer;} .controls.unlocked .btn:active{transform:translateY(4px);}
        .btn-red{background:var(--red);} .btn-blue{background:var(--blue);} .btn-green{background:var(--green);}
        
        #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.98);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:100;}

        /* --- ç§»åŠ¨ç«¯é€‚é… (é’ˆå¯¹é«˜åº¦è¾ƒå°çš„ Iframe) --- */
        @media (max-height: 500px), (max-width: 600px) {
            .hud { font-size: 1rem; margin-bottom: 5px; }
            .grid-container { gap: 6px; margin-bottom: 10px; }
            .card { font-size: 0.85rem; border-width: 1px; border-radius: 6px; }
            .card.target { border-width: 2px; }
            .controls { height: 50px; }
            .btn { font-size: 0.9rem; border-radius: 8px; }
        }
    </style>
</head>
<body>
<div class="hud"><span>LEVEL <span id="level-num">1</span> / 5</span><span id="state-text">å‡†å¤‡</span></div>
<div class="status-bar"><div class="status-fill" id="status-bar"></div></div>
<div class="grid-container" id="grid"></div>
<div class="controls" id="controls">
<button class="btn btn-red" onclick="inp('block')">A æ‹¦æˆª</button><button class="btn btn-blue" onclick="inp('antivirus')">S æŸ¥æ€</button><button class="btn btn-green" onclick="inp('pass')">D æ”¾è¡Œ</button>
</div>
<div id="overlay"><h1 id="ov-title"></h1></div>
<script>
const BPM=140, BEAT=60000/BPM, LEVELS=5;
const DATA={block:['SQLæ³¨å…¥','DDOS','ä¸­é—´äºº'],antivirus:['æœ¨é©¬','å¹¿å‘Š','é—´è°'],pass:['ctshkpccæ ¡ç½‘']};
let st={phase:'idle',level:1,items:[],idx:0,usedNet:false,tmr:null,btmr:null}, ac;
const els={grid:document.getElementById('grid'),bar:document.getElementById('status-bar'),lvl:document.getElementById('level-num'),txt:document.getElementById('state-text'),ov:document.getElementById('overlay'),ctrl:document.getElementById('controls')};

window.addEventListener('message',e=>{if(e.data==='START_GAME')init();});
document.addEventListener('keydown',e=>{
    if(st.phase==='action'){const k=e.key.toLowerCase();if(k==='a')inp('block');else if(k==='s')inp('antivirus');else if(k==='d')inp('pass');}
    if(e.key.toLowerCase() === 'u') { next(); }
});

function init(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)();if(ac.state==='suspended')ac.resume();st.level=1;st.usedNet=false;els.lvl.innerText=1;els.ov.style.display='none';start();}
function snd(t){if(!ac)return;const o=ac.createOscillator(),g=ac.createGain();
if(t==='w'){o.type='triangle';o.frequency.setValueAtTime(800,ac.currentTime);o.frequency.exponentialRampToValueAtTime(400,ac.currentTime+0.1);g.gain.setValueAtTime(0.5,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.01,ac.currentTime+0.1);o.connect(g);g.connect(ac.destination);o.start();o.stop(ac.currentTime+0.15);}
else{const b=ac.createBuffer(1,ac.sampleRate*0.3,ac.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const n=ac.createBufferSource();n.buffer=b;const f=ac.createBiquadFilter();f.type='lowpass';f.frequency.value=600;g.gain.setValueAtTime(0,ac.currentTime);g.gain.linearRampToValueAtTime(0.2,ac.currentTime+0.05);g.gain.linearRampToValueAtTime(0,ac.currentTime+0.3);n.connect(f);f.connect(g);g.connect(ac.destination);n.start();}}

function start(){
    st.idx=0;st.items=[];els.grid.innerHTML='';els.ctrl.classList.remove('unlocked');els.grid.classList.remove('active');
    for(let i=0;i<8;i++){
        let type,name;const sp=!st.usedNet&&(Math.random()<0.25||st.level===5);
        if(sp&&!st.items.some(x=>x.type==='pass')){type='pass';name=DATA.pass[0];st.usedNet=true;}
        else{type=Math.random()>0.5?'block':'antivirus';name=DATA[type][Math.floor(Math.random()*DATA[type].length)];}
        st.items.push({type,name});
        const c=document.createElement('div');c.className='card';c.id='c-'+i;c.innerText=name;els.grid.appendChild(c);
    }
    st.phase='prep';els.txt.innerText="å¬èŠ‚å¥...";els.txt.style.color="#636e72";els.bar.style.width='0%';
    let b=0;st.btmr=setInterval(()=>{if(b<8){snd('w');els.bar.className='status-fill prep';els.bar.style.width=((b+1)/8*100)+'%';const c=document.getElementById('c-'+b);if(c)c.classList.add('rhythm-hit');b++;}else{clearInterval(st.btmr);act();}},BEAT);
}

function act(){
    st.phase='action';els.txt.innerText="è¡ŒåŠ¨ï¼";els.txt.style.color="#e74c3c";els.ctrl.classList.add('unlocked');els.grid.classList.add('active');hl();
    let wc=0,wt=setInterval(()=>{if(st.phase!=='action'){clearInterval(wt);return;}if(wc<8){snd('f');wc++;}else clearInterval(wt);},BEAT);
    let startT=Date.now(),tot=BEAT*8+1000;
    clearInterval(st.tmr);st.tmr=setInterval(()=>{let elp=Date.now()-startT,rem=tot-elp;els.bar.className='status-fill action';els.bar.style.width=(rem/tot*100)+'%';if(rem<=0){fail("æ—¶é—´è€—å°½");}},30);
}

function hl(){document.querySelectorAll('.card').forEach(c=>c.classList.remove('target'));if(st.idx<8){const c=document.getElementById('c-'+st.idx);if(c){c.classList.remove('rhythm-hit');c.classList.add('target');}}}
function inp(t){if(st.phase!=='action'||st.idx>=8)return;const it=st.items[st.idx],c=document.getElementById('c-'+st.idx);
if(t===it.type){c.classList.add('done');st.idx++;if(st.idx>=8)next();else hl();}else{c.classList.add('wrong');fail(t==='pass'?"æ”¾è¡Œäº†å±é™©ç›®æ ‡":"æ“ä½œå¤±è¯¯");}}

function next(){
    st.phase='res';clearInterval(st.tmr);
    if(st.level>=LEVELS){
        els.ov.style.display='flex';document.getElementById('ov-title').innerText="ä»»åŠ¡å®Œæˆ";
        setTimeout(()=>window.parent.postMessage({type:'GAME_OVER',win:true},'*'),1000);
    }else{st.level++;els.lvl.innerText=st.level;setTimeout(start,1000);}
}

function fail(r){
    st.phase='res';clearInterval(st.tmr);clearInterval(st.btmr);
    els.ov.style.display='flex';document.getElementById('ov-title').innerText="é˜²å¾¡å¤±è´¥";
    window.parent.postMessage({type:'GAME_OVER',win:false,reason:r},'*');
}
<\/script></body></html>`;

        const gameState = { step: 0, typing: false, currentGame: 0 };
        const els = {
            speaker: document.getElementById('speaker-name'),
            text: document.getElementById('text-box'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            startOverlay: document.getElementById('start-overlay'),
            charImg: document.getElementById('char-img'),
            vnLayers: document.getElementById('vn-layers'),
            gameWrapper: document.getElementById('game-stage-wrapper'),
            gameIframe: document.getElementById('game-iframe'),
            gameStartMask: document.getElementById('game-start-mask'),
            gameActionBtn: document.getElementById('btn-game-action'),
            miniChar: document.getElementById('mini-char-img'),
            miniSpeaker: document.getElementById('mini-speaker-name'),
            miniText: document.getElementById('mini-text')
        };

        // --- åŠ‡æœ¬å…§å®¹ ---
        const script = [
            { speaker: 'SYSTEM', text: 'ã€ç³»çµ±æç¤ºã€‘ç”Ÿç‰©è­˜åˆ¥é€šéã€‚æ­£åœ¨å»ºç«‹åŠ å¯†é€šè¨Š...', image: null },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'çœ‹èµ·æ¥ä½ çŠ¶æ€ä¸é”™å˜›!', image: null },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ—©ä¸Šå¥½ï¼Œæ–°å…µã€‚æˆ‘æ˜¯ Evaï¼Œä½ çš„å…¥è·å¼•å°å“¡ã€‚', image: IMG_NORMAL },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ¥åˆ°è¿™é‡Œï¼Œå°±æ„å‘³è‘—ä½ å·²ç¶“å‡†å¤‡å¥½å…³äºã€Šç½‘ç»œå®‰å…¨ã€‹è€ƒæ ¸ï¼Œæˆä¸ºä¸€åç½‘ç»œæ‰§æ³•è€…äº†', image: IMG_NORMAL }, 
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'è€ƒæ ¸å†…å®¹åŒ…æ‹¬ä½†ä¸é™äº:ç—…æ¯’ç±»å‹,å¸¸è§çš„ç½‘ç»œæ”»å‡»æ‰‹æ®µä»¥åŠå¦‚ä½•é˜²èŒƒ,ç¤¾äº¤å·¥ç¨‹å­¦ç­‰ç­‰', image: IMG_NORMAL },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'è¶ç°åœ¨è€ƒæ ¸å®˜è¿˜æ²¡æ¥ï¼Œæˆ‘å…ˆè¯´å‡ ä¸ªå…³äºç¤¾äº¤å·¥ç¨‹æ¡ˆä¾‹', image: IMG_NORMAL },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ¡ˆä¾‹ä¸€ï¼šå› ä¸ºå…è´¹çš„ç¦åˆ©èµ„æºï¼Œè¿›å…¥é’“é±¼ç½‘ç«™ï¼Œæˆ‘ä»¬å‘ç°æ—¶ï¼Œè„‘æœºè¢«æ³¨å…¥äº†æœ¨é©¬ç¨‹åºï¼Œç°åœ¨è¿˜åœ¨åŒ»é™¢ï¼Œè¦çŸ¥é“ã€Šå…è´¹çš„æ‰æ˜¯æœ€è´µçš„ã€‹', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ¡ˆä¾‹äºŒï¼šå› ä¸ºä¸‹è½½ç¦åˆ©èµ„æºï¼Œå°±å…³é—­äº†é˜²ç«å¢™æˆ–è€…æ€æ¯’è½¯ä»¶ï¼Œäº²æ‰‹æŠŠé˜²çº¿å…¨éƒ¨è§£å¼€ï¼Œç°åœ¨å’Œä¸Šä¸€ä¸ªäººæ˜¯ç—…å‹', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ¡ˆä¾‹ä¸‰ï¼šç”¨ä»»ä½•ä¸ªäººä¿¡æ¯åœ¨äº’è”ç½‘å’Œæ‰€è°“çš„â€œç¾å¥³â€äº¤æ¢è”ç³»æ–¹å¼ï¼Œç„¶åè„‘æœºæ¯ä¸€åˆ»éƒ½åœ¨æ”¶åˆ°åƒåœ¾é‚®ä»¶å’Œç”µä¿¡', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text:'å¸Œæœ›è¿™äº›äº‹æƒ…ä½ éƒ½æ²¡åšè¿‡,å“ˆå“ˆå“ˆ ', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æˆ‘ä»¬æ¯æ—¶æ¯åˆ»éƒ½åœ¨ä¸ºç¾¤ä¼—å®£ä¼ ç½‘ç»œå®‰å…¨,ä½†æ˜¯ä¸æ³•åˆ†å­æ¯”æˆ‘ä»¬æ›´æ‡‚åº”ç”¨äººæ€§', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text:'æ‰€ä»¥å°±éœ€è¦æˆ‘ä»¬åœ¨äº’è”ç½‘ä¸Šç»´æŠ¤æ²»å®‰', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'è¯´äº†è¿™ä¹ˆå¤šæ—¶é—´å·®ç‚¹è¿‡äº†å…³äº ç¤¾äº¤å·¥ç¨‹ çš„æ¡ˆä¾‹,å¸Œæœ›ä½ ä¸€ä¼šåœ¨è€ƒæ ¸ä¸­å°±ä¸è¦é”™äº†,ç°åœ¨è·³è½¬åˆ°#0375å°±å¯ä»¥å¼€å§‹è€ƒæ ¸äº†~', image: IMG_NORMAL },
            { speaker: 'SYSTEM', text: 'ã€éˆæ¥ä¸­æ–·ã€‘èŒ‰è‰ å·²ä¸‹ç·š,æ­£åœ¨é“¾æ¥#0375', image: null },
            { speaker: 'è¾­ç†’(è€ƒæ ¸å®˜)', text: 'ä¹…ç­‰äº†ï¼Œæˆ‘è´Ÿè´£çš„è€ƒæ ¸å†…å®¹æ˜¯ç½‘ç»œæ”»å‡»æ‰‹æ®µå’Œåº”å¯¹æ–¹æ³•', image: IMG_CIYING },
            { speaker: 'è¾­ç†’(è€ƒæ ¸å®˜)', text: 'ä½ éœ€è¦ç²¾å‡†åˆ†è¾¨ç—…æ¯’æˆ–æ”»å‡»æ‰‹æ®µï¼Œå°†ä»–ä»¬å…¨éƒ¨é“²é™¤ï¼ï¼ˆæ»‘å‹•å±å¹•æˆ–è€…éŠæ ‡ï¼‰ï¼Œé€”ä¸­æ³¨æ„ä¸è¦æ”»å‡»å‹å†›ï¼', image: IMG_CIYING },
            { type: 'GAME1_PREPARE' },
        ];

        function preloadImages() {
            [IMG_NORMAL, IMG_RULES, IMG_CIYING, IMG_TWINS].forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        function initSystem() {
            preloadImages();
            els.startOverlay.style.opacity = '0';
            setTimeout(() => { els.startOverlay.style.display = 'none'; }, 500);
            renderStep();
        }

        function updateProgress() {
            const percentage = Math.floor(((gameState.step + 1) / script.length) * 100);
            els.progressBar.style.width = percentage + '%';
            els.progressText.innerText = percentage + '%';
        }

        function renderStep() {
            const currentScript = script[gameState.step];
            
            if (currentScript.type === 'GAME1_PREPARE') {
                prepareGame(1, IMG_CIYING, "è¾è§", "è¯·å‡†å¤‡å¥½ï¼Œè€ƒæ ¸å³å°†å¼€å§‹...", GAME1_SOURCE_CODE);
                return;
            }
            if (currentScript.type === 'GAME2_PREPARE') {
                prepareGame(2, IMG_TWINS, "ç¾½å²š & ç¾½æ™“", "å¬å¥½èŠ‚å¥ï¼Œé˜²å¾¡å³å°†å¼€å§‹...", GAME2_SOURCE_CODE);
                return;
            }

            // å¦‚æœæ˜¯æ–‡æœ¬å°è©±ï¼Œç¢ºä¿é¡¯ç¤º VN å±¤
            if (!currentScript.type) {
                // å¦‚æœ VN å±¤æ˜¯éš±è—çš„ï¼Œç¢ºä¿å®ƒé¡¯ç¤ºå‡ºä¾†
                if (els.vnLayers.style.display === 'none') {
                     els.vnLayers.style.display = 'block';
                     els.vnLayers.style.opacity = '1';
                }
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç»“æŸè¯­å¹¶æ‰§è¡Œè·³è½¬
            const nextInd = document.querySelector('.next-indicator');
            if (currentScript.text && currentScript.text.includes('ã€è€ƒæ ¸ç»“æŸã€‘')) {
                if(nextInd) nextInd.style.display = 'none'; // éšè—ç»§ç»­æŒ‰é’®ï¼Œé˜²æ­¢è¯¯è§¦
                document.getElementById('dialogue-layer').onclick = null; // ç¦ç”¨ç‚¹å‡»
                
                setTimeout(() => {
                    window.location.href = "https://goog-ie-com.vercel.app/";
                }, 3000);
            } else {
                if(nextInd) nextInd.style.display = 'block';
                document.getElementById('dialogue-layer').onclick = nextStep; // æ¢å¤ç‚¹å‡»
            }

            if (currentScript.image) {
                if (els.charImg.src !== currentScript.image) {
                    if (els.charImg.style.opacity === '1') {
                        els.charImg.style.opacity = '0';
                        setTimeout(() => {
                            els.charImg.src = currentScript.image;
                            els.charImg.style.opacity = '1';
                        }, 300);
                    } else {
                        els.charImg.src = currentScript.image;
                        setTimeout(() => els.charImg.style.opacity = '1', 50);
                    }
                } else {
                    els.charImg.style.opacity = '1';
                }
            } else {
                els.charImg.style.opacity = '0';
            }

            els.speaker.innerText = currentScript.speaker;
            els.speaker.style.background = currentScript.speaker.includes('SYSTEM') ? '#555' : 'var(--police-dark)';
            els.text.innerHTML = '';
            gameState.typing = true;
            let i = 0;
            const content = currentScript.text;
            
            function typeWriter() {
                if (i < content.length) {
                    els.text.innerHTML += content.charAt(i) === '\n' ? '<br>' : content.charAt(i);
                    i++;
                    setTimeout(typeWriter, 25);
                } else {
                    gameState.typing = false;
                }
            }
            typeWriter();
            updateProgress();
        }

        function nextStep() {
            if (gameState.typing) return;
            gameState.step++;
            if (gameState.step < script.length) {
                renderStep();
            } else {
                console.log("End of script");
            }
        }

        function prepareGame(gameId, charImg, speakerName, initialText, sourceCode) {
            gameState.currentGame = gameId;
            // éš±è—å°è©±å±¤
            els.vnLayers.style.opacity = '0';
            setTimeout(() => {
                els.vnLayers.style.display = 'none';
                els.gameWrapper.style.display = 'flex';
                
                els.miniChar.src = charImg;
                els.miniSpeaker.innerText = speakerName + ":";
                updateMiniText(initialText);
                
                els.gameIframe.srcdoc = sourceCode;
                els.gameStartMask.style.display = 'flex';
                els.gameActionBtn.innerText = "é–‹å§‹è€ƒæ ¸";
            }, 500);

            els.progressBar.style.width = '100%';
            els.progressText.innerText = 'è€ƒæ ¸æº–å‚™';
        }

        function triggerGameStart() {
            els.gameStartMask.style.display = 'none';
            const iframeWin = els.gameIframe.contentWindow;
            iframeWin.postMessage('START_GAME', '*');
            if(gameState.currentGame === 1) updateMiniText("å¸Œæœ›ä½ çœŸçš„åšå¥½äº†å‡†å¤‡");
            else updateMiniText("é›†ä¸­æ³¨æ„åŠ›ï¼Œè·Ÿä¸ŠèŠ‚å¥ï¼");
        }

        function updateMiniText(text) {
            els.miniText.innerText = text;
        }

        function backToVN() {
            // éš±è—éŠæˆ²å±¤ï¼Œé¡¯ç¤ºå°è©±å±¤
            els.gameWrapper.style.display = 'none';
            els.vnLayers.style.display = 'block';
            // å¼·åˆ¶é‡ç¹ªç¢ºä¿ transition ç”Ÿæ•ˆ
            void els.vnLayers.offsetWidth; 
            els.vnLayers.style.opacity = '1';
        }

        window.addEventListener('message', function(e) {
            const data = e.data;
            if (!data.type) return;

            if (data.type === 'PHASE_CHANGE') {
                updateMiniText("ç°åœ¨å¼€å§‹å‡ºç°é˜²å¾¡æ‰‹æ®µäº†å“Ÿï¼Œæ³¨æ„æ•Œæˆ‘è¯†åˆ«");
            } 
            else if (data.type === 'GAME_OVER') {
                if (!data.win) {
                    updateMiniText((data.reason || "è€ƒæ ¸å¤±è´¥") + "ï¼Œä½ éœ€è¦é‡æ–°å¼€å§‹è€ƒæ ¸");
                    setTimeout(() => {
                        els.gameStartMask.style.display = 'flex';
                        els.gameActionBtn.innerText = "é‡æ–°è€ƒæ ¸";
                    }, 500); 
                } else {
                    if (gameState.currentGame === 1) {
                        updateMiniText("è¡¨ç°ä¸é”™ï¼Œå¨èƒæ¸…é™¤");
                        setTimeout(() => {
                            // 1. åˆ‡æ›å›å°è©±æ¨¡å¼
                            backToVN();
                            
                            // 2. æº–å‚™åŠ‡æœ¬
                            const isPerfect = (data.maxCombo === data.totalTargets) && (data.totalTargets > 0);
                            const resultText = isPerfect 
                                ? "æ­å–œä½ å®Œç¾é€šè¿‡äº†æœ¬æ¬¡è€ƒæ ¸ï¼Œä½ å¯ä»¥å»æ‰¾ä¸‹ä¸€ä¸ªè€ƒå®˜äº†" 
                                : "ä¸”ç®—å·²é€šè¿‡çš„æœ¬æ¬¡è€ƒæ ¸ï¼Œä½ å¯ä»¥å»æ‰¾ä¸‹ä¸€ä¸ªè€ƒå®˜äº†";
                            
                            // æ’å…¥å¾ŒçºŒå°è©±
                            script.splice(gameState.step + 1, 0, 
                                { speaker: 'è¾­ç†’(è€ƒæ ¸å®˜)', text: resultText, image: IMG_CIYING },
                                { speaker: 'SYSTEM', text: 'æ­£åœ¨è·³è½¬#7098', image: null },
                                { speaker: 'ç¾½å²š & ç¾½æ™“', text: 'ä½ å¥½è€ƒç”Ÿé€šè¿‡æˆ‘ä»¬çš„è€ƒéªŒä½ å°±èƒ½å®Œæˆè€ƒéªŒ,æˆä¸ºä¸€åæ‰§æ³•äººå‘˜äº†!', image: IMG_TWINS },
                                { type: 'GAME2_PREPARE' }
                            );

                            // 3. æ‰‹å‹•æ¨é€²ä¸€æ­¥ä¸¦å¼·åˆ¶æ¸²æŸ“ï¼Œç¢ºä¿ä¸æœƒå› ç‚º display:none è¢«è·³é
                            gameState.step++;
                            setTimeout(renderStep, 100); 

                        }, 2000);

                    } else if (gameState.currentGame === 2) {
                        updateMiniText("èŠ‚å¥å®Œç¾ï¼Œé˜²å¾¡æˆåŠŸï¼");
                        setTimeout(() => {
                            backToVN();
                            script.splice(gameState.step + 1, 0, 
                                { speaker: 'ç¾½å²š & ç¾½æ™“', text: 'æ­å–œä½ ï¼æ¬¢è¿åŠ å…¥ HKPCï¼Œæ–°çš„æ‰§æ³•è€…ã€‚', image: IMG_TWINS },
                                { speaker: 'SYSTEM', text: 'ã€è€ƒæ ¸ç»“æŸã€‘æ¡£æ¡ˆå½•å…¥å®Œæˆã€‚', image: null }
                            );
                            gameState.step++;
                            setTimeout(renderStep, 100);
                        }, 2000);
                    }
                }
            }
        });
    </script>
</body>
</html>

