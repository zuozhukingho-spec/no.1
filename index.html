<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N.S.B. å…§éƒ¨å®‰å…¨å¯©æŸ¥ç³»çµ±</title>
    <style>
        /* --- 1. è¦–è¦ºæ ¸å¿ƒ --- */
        :root {
            --police-dark: #0a2342;
            --police-blue: #0056b3;
            --text-main: #1a1a1a;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 8px 30px rgba(10, 35, 66, 0.2);
            --border: #cadae8;
        }

        body {
            margin: 0; padding: 0;
            background-color: #f4f7fa;
            background-image: 
                linear-gradient(rgba(10, 35, 66, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(10, 35, 66, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            position: relative;
        }

        /* --- 2. é ‚éƒ¨ç‹€æ…‹æ¬„ --- */
        .top-hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: var(--police-dark); color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; box-sizing: border-box; z-index: 100;
        }
        .progress-module {
            display: flex; align-items: center; gap: 15px;
            background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 4px;
        }
        .progress-track { width: 200px; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #00d2ff; transition: width 0.5s; }

        /* --- 3. äººç‰©ç«‹ç¹ªå±¤ --- */
        #character-stage {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 10; pointer-events: none; overflow: hidden;
            transition: opacity 0.5s;
        }
        .character-img {
            position: absolute; left: 50%; bottom: 0;
            height: 85vh; width: auto; max-width: 80vw;
            transform: translateX(-50%) translateZ(0);
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5));
            animation: float-only 6s ease-in-out infinite; 
            transition: opacity 0.3s ease-in-out; 
            opacity: 0;
        }
        @keyframes float-only {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* --- 4. å°è©±æ¡† --- */
        #dialogue-layer {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 1100px; height: 240px; z-index: 50;
            pointer-events: auto; cursor: pointer;
            transition: opacity 0.5s;
        }
        .dialogue-box {
            width: 100%; height: 100%; background: var(--glass);
            border: 1px solid var(--border); border-top: 4px solid var(--police-dark);
            border-radius: 8px; padding: 50px 40px 30px 40px;
            box-sizing: border-box; box-shadow: var(--shadow);
            backdrop-filter: blur(15px); display: flex; flex-direction: column;
        }
        .name-tag {
            position: absolute; top: -22px; left: 40px;
            background: var(--police-dark); color: white; padding: 8px 35px;
            font-size: 1.1rem; border-radius: 4px; display: flex; align-items: center; gap: 10px;
        }
        .name-tag::before { content: ''; display: block; width: 8px; height: 8px; background: #00d2ff; border-radius: 50%; }
        .text-content { font-size: 1.2rem; line-height: 1.6; color: var(--text-main); font-weight: 500; flex: 1; }
        .next-indicator { align-self: flex-end; color: var(--police-blue); font-weight: bold; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(5px); } }

        /* --- 5. éŠæˆ²è€ƒæ ¸æ¨¡å¼å®¹å™¨ --- */
        #game-stage-wrapper {
            position: absolute;
            top: 55%; left: 50%;
            transform: translate(-50%, -50%);
            width: 95%; max-width: 480px;
            height: auto;
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .game-header-area {
            position: relative; height: 140px; width: 100%;
            display: flex; align-items: flex-end; margin-bottom: -5px;
        }
        .mini-char-container {
            position: absolute; right: 0; bottom: 0;
            width: 45%; height: 100%; z-index: 2;
        }
        .mini-char-img {
            width: 100%; height: 100%;
            object-fit: contain; object-position: bottom right;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));
        }
        .mini-dialogue-box {
            position: relative; width: 60%;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--police-dark);
            border-radius: 12px 12px 0 12px;
            padding: 12px; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 0.9rem; line-height: 1.4; color: #333;
            z-index: 1; transition: all 0.3s;
        }
        .mini-dialogue-box::after {
            content: ''; position: absolute; bottom: -8px; right: -8px;
            border-width: 10px 10px 0; border-style: solid;
            border-color: var(--police-dark) transparent;
            display: block; width: 0;
        }
        
        .game-frame-container {
            width: 100%; height: 50vh;
            border: 4px solid var(--police-dark);
            border-radius: 10px; overflow: hidden;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative; z-index: 10;
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* éŠæˆ²é–‹å§‹/é‡è©¦é®ç½© */
        #game-start-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 20;
        }
        .btn-game-start {
            background: #00d2ff; color: #0a2342;
            border: 2px solid #fff; padding: 15px 30px;
            font-size: 1.2rem; font-weight: bold;
            border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 20px #00d2ff;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- å…¨å±€é®ç½©å±¤ --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 1000; display: flex;
            justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s;
        }
        .btn-start {
            margin-top: 30px; padding: 15px 40px; background: var(--police-dark);
            color: white; border: none; border-radius: 4px; font-size: 1.2rem; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="top-hud">
        <div class="logo-area"><span>ğŸ›¡ï¸</span> <span>N.S.B. è€ƒæ ¸ç³»çµ±</span></div>
        <div class="progress-module">
            <span style="font-size: 0.85rem;">é€²åº¦</span>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
            <span id="progress-text">0%</span>
        </div>
    </div>

    <div id="vn-layers">
        <div id="character-stage">
            <img id="char-img" src="" alt="Character" class="character-img">
        </div>

        <div id="dialogue-layer" onclick="nextStep()">
            <div class="dialogue-box">
                <div class="name-tag" id="speaker-name">SYSTEM</div>
                <div class="text-content" id="text-box">ç­‰å¾…éˆæ¥...</div>
                <div class="next-indicator">é»æ“Šç¹¼çºŒ â–¶</div>
            </div>
        </div>
    </div>

    <div id="game-stage-wrapper">
        <div class="game-header-area">
            <div class="mini-dialogue-box" id="mini-dialogue-content">
                <b>è¾­ç†’:</b><br>
                <span id="mini-text">è¯·å‡†å¤‡å¥½ï¼Œè€ƒæ ¸å³å°†å¼€å§‹...</span>
            </div>
            <div class="mini-char-container">
                <img id="mini-char-img" src="" class="mini-char-img">
            </div>
        </div>
        <div class="game-frame-container">
            <div id="game-start-mask">
                <button id="btn-game-action" class="btn-game-start" onclick="triggerGameStart()">é–‹å§‹è€ƒæ ¸</button>
            </div>
            <iframe id="game-iframe"></iframe>
        </div>
    </div>

    <div id="start-overlay" class="overlay">
        <h1 style="color: var(--police-dark);">ğŸ›¡ï¸ N.S.B. å…¥è·è€ƒæ ¸</h1>
        <button class="btn-start" onclick="initSystem()">é–‹å§‹éˆæ¥</button>
    </div>

    <script>
        // --- è³‡æºé…ç½® ---
        const IMG_NORMAL = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260204194356403.png";
        const IMG_RULES  = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260204193719993.png"; 
        const IMG_CIYING = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260205175449109.png";

        // --- éŠæˆ²æºä»£ç¢¼ (1:1 å¾©åˆ»åˆ‡è¥¿ç“œé‚è¼¯ + å®Œç¾åˆ¤å®š) ---
        const GAME_SOURCE_CODE = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NSB è€ƒæ ¸</title>
    <style>
        body { margin: 0; background: #ffffff; color: #333; overflow: hidden; font-family: 'Microsoft YaHei', sans-serif; user-select: none; -webkit-user-select: none; }
        canvas { display: block; touch-action: none; cursor: crosshair; }
        
        #ui { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; padding: 15px; box-sizing: border-box;
            z-index: 10;
        }
        
        .header-row { display: flex; justify-content: space-between; width: 100%; max-width: 800px; margin: 0 auto 10px auto; }
        .combo-row { display: flex; justify-content: center; gap: 20px; width: 100%; }
        .stat-box { 
            background: rgba(240, 240, 240, 0.95); padding: 5px 15px; border-radius: 20px; 
            border: 2px solid #ddd; font-size: 16px; font-weight: bold; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .combo-box { color: #d35400; border-color: #f39c12; transform: scale(1); transition: transform 0.1s; }
        .combo-active { transform: scale(1.2); }
        .max-box { color: #7f8c8d; font-size: 14px; margin-top: 2px;}
        .lives { color: #ff3333; letter-spacing: 2px; }
        .timer { color: #333; font-family: monospace; font-size: 20px; min-width: 50px; text-align: center; }
        
        #game-over {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; display: none; z-index: 100;
            background: rgba(255, 255, 255, 0.98); padding: 20px 40px; border-radius: 20px;
            border: 4px solid #333; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); width: 70%;
        }
        h1 { margin: 0; color: #333; font-size: 28px; }
        p, button, #end-desc { display: none; } /* éš±è—å…·é«”å…§å®¹ï¼Œç”±å¤–éƒ¨æ§åˆ¶ */
        #flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; z-index: 5; transition: opacity 0.1s; }
    </style>
</head>
<body>
<div id="flash"></div>
<div id="ui">
    <div class="header-row">
        <div class="stat-box">å¾—åˆ†: <span id="score-val">0</span></div>
        <div class="stat-box timer"><span id="time-val">60</span>s</div>
        <div class="stat-box lives" id="lives-val">â¤ï¸â¤ï¸â¤ï¸</div>
    </div>
    <div class="combo-row">
        <div class="stat-box combo-box" id="combo-container">è¿å‡»: <span id="combo-val">0</span></div>
        <div class="stat-box max-box">æœ€é«˜: <span id="max-combo-val">0</span></div>
    </div>
</div>
<div id="game-over"><h1 id="end-title">æ¸¸æˆç»“æŸ</h1></div>
<canvas id="c"></canvas>
<script>
const CFG = { gravity: 0.025, drag: 0.998, gameTime: 60, safePhase: 20, countP1: [1, 2], countP2: [2, 4], interval: 2200 };
const canvas = document.getElementById('c'); const ctx = canvas.getContext('2d');
const ui = { score: document.getElementById('score-val'), time: document.getElementById('time-val'), lives: document.getElementById('lives-val'), combo: document.getElementById('combo-val'), comboContainer: document.getElementById('combo-container'), maxCombo: document.getElementById('max-combo-val'), panel: document.getElementById('game-over'), title: document.getElementById('end-title'), flash: document.getElementById('flash') };
const DATA = { BAD: [{t:'æœ¨é©¬ç—…æ¯’',c:'#e74c3c'},{t:'é—´è°è½¯ä»¶',c:'#c0392b'},{t:'DDoSæ”»å‡»',c:'#d35400'},{t:'ä¸­é—´äººæ”»å‡»',c:'#8e44ad'},{t:'é’“é±¼ç½‘ç«™',c:'#c0392b'},{t:'å‹’ç´¢è½¯ä»¶',c:'#2c3e50'},{t:'ç—…æ¯’è½¯ä»¶',c:'#e67e22'},{t:'è •è™«ç—…æ¯’',c:'#d35400'}], GOOD: [{t:'é˜²ç«å¢™',c:'#27ae60'},{t:'é˜²æ¯’è½¯ä»¶',c:'#2ecc71'},{t:'VPNä»£ç†',c:'#16a085'},{t:'åŠ å¯†',c:'#1abc9c'},{t:'æ•°æ®å¤‡ä»½',c:'#2980b9'}] };

let state = { score: 0, combo: 0, maxCombo: 0, lives: 3, active: false, start: 0, objs: [], parts: [], blade: { points: [], isDown: false }, phaseAlerted: false, totalTargets: 0 };
let spawnTimer = null; let animId = null;

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.onresize = resize; resize();
window.addEventListener('message', function(e) { if(e.data === 'START_GAME') startGame(); });

class Item {
    constructor(data, isTool) {
        this.text = data.t; this.color = data.c; this.isTool = isTool; this.r = 60; this.sliced = false;
        this.x = Math.random() * (canvas.width * 0.8) + (canvas.width * 0.1); this.y = canvas.height + 70;
        const targetX = canvas.width / 2 + (Math.random()-0.5) * 300; const targetY = canvas.height * 0.35; 
        const h = this.y - targetY; const vy = Math.sqrt(2 * CFG.gravity * h); const t = vy / CFG.gravity;
        this.vy = -vy; this.vx = (targetX - this.x) / t; this.angle = 0; this.spin = (Math.random() - 0.5) * 0.02;
    }
    update() { this.x += this.vx; this.y += this.vy; this.vy += CFG.gravity; this.vx *= CFG.drag; this.angle += this.spin; return this.y > canvas.height + 100; }
    draw() {
        ctx.translate(this.x, this.y); ctx.save(); ctx.rotate(this.angle);
        ctx.beginPath(); ctx.arc(0, 0, this.r, 0, Math.PI*2); ctx.fillStyle = this.color; ctx.fill();
        ctx.lineWidth = 4; ctx.strokeStyle = this.isTool ? '#2c3e50' : '#fff'; ctx.stroke();
        if(this.isTool) { ctx.beginPath(); ctx.arc(0,0, this.r - 8, 0, Math.PI*2); ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.stroke(); }
        ctx.restore(); ctx.fillStyle = '#fff'; ctx.font = 'bold 22px "Microsoft YaHei"';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(this.text, 0, 0); ctx.translate(-this.x, -this.y);
    }
}
class Part {
    constructor(x, y, c) { this.x = x; this.y = y; this.c = c; this.vx = (Math.random()-0.5)*10; this.vy = (Math.random()-0.5)*10; this.life = 1; }
    update() { this.x+=this.vx; this.y+=this.vy; this.vy+=0.1; this.life-=0.02; }
    draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.c; ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; }
}

function startGame() {
    state = { score: 0, combo: 0, maxCombo: 0, lives: 3, active: true, start: Date.now(), objs: [], parts: [], blade: { points: [], isDown: false }, phaseAlerted: false, totalTargets: 0 };
    ui.panel.style.display = 'none'; ui.score.innerText = '0'; ui.lives.innerText = 'â¤ï¸â¤ï¸â¤ï¸'; ui.combo.innerText = '0'; ui.maxCombo.innerText = '0'; ui.time.innerText = CFG.gameTime;
    if(spawnTimer) clearTimeout(spawnTimer); if(animId) cancelAnimationFrame(animId);
    spawn(); loop();
}
function updateCombo(increment) {
    if (increment) { state.combo++; if (state.combo > state.maxCombo) { state.maxCombo = state.combo; ui.maxCombo.innerText = state.maxCombo; } ui.comboContainer.classList.remove('combo-active'); void ui.comboContainer.offsetWidth; ui.comboContainer.classList.add('combo-active'); } 
    else { state.combo = 0; } ui.combo.innerText = state.combo;
}
function spawn() {
    if(!state.active) return;
    const passed = (Date.now() - state.start)/1000;
    const limits = passed < CFG.safePhase ? CFG.countP1 : CFG.countP2;
    const count = Math.floor(Math.random() * (limits[1] - limits[0] + 1)) + limits[0];
    const existingWords = new Set(state.objs.map(o => o.text));
    const availableBad = DATA.BAD.filter(item => !existingWords.has(item.t));
    const availableGood = DATA.GOOD.filter(item => !existingWords.has(item.t));
    
    for(let i=0; i<count; i++) {
        let isTool = passed < CFG.safePhase ? false : (Math.random() < 0.15);
        let pool = isTool ? availableGood : availableBad;
        if(pool.length === 0) pool = isTool ? availableBad : availableGood;
        if(pool.length > 0) {
            const idx = Math.floor(Math.random() * pool.length);
            // é€™è£¡çµ±è¨ˆç¸½ç›®æ¨™æ•¸ï¼šå¦‚æœä¸æ˜¯ Toolï¼Œå‰‡ totalTargets + 1
            if(pool === availableBad) state.totalTargets++;
            setTimeout(() => { if(state.active) state.objs.push(new Item(pool[idx], pool === availableGood)); }, i * 500);
        }
    }
    spawnTimer = setTimeout(spawn, CFG.interval);
}
function takeDamage(reason) {
    if(!state.active) return; state.lives--; updateCombo(false);
    ui.flash.style.opacity = 0.3; setTimeout(() => ui.flash.style.opacity = 0, 100); ui.lives.innerText = "â¤ï¸".repeat(state.lives);
    if(state.lives <= 0) over(false, reason);
}
function handleInput(x, y, isDown) {
    if(!state.active) return;
    if(isDown) { state.blade.isDown = true; state.blade.points.push({x, y}); } else { state.blade.isDown = false; state.blade.points = []; return; }
    state.objs.forEach((o, i) => {
        if(o.sliced) return;
        if(Math.hypot(o.x - x, o.y - y) < o.r) {
            o.sliced = true; for(let k=0; k<15; k++) state.parts.push(new Part(o.x, o.y, o.color));
            if(o.isTool) { takeDamage("è¯¯ä¼¤å‹å†›"); } else { state.score += 10; updateCombo(true); ui.score.innerText = state.score; }
            state.objs.splice(i, 1);
        }
    });
}
function drawBlade() {
    const pts = state.blade.points; if(pts.length < 2) return; ctx.save(); ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    for(let i=1; i<pts.length; i++) { ctx.beginPath(); ctx.moveTo(pts[i-1].x, pts[i-1].y); ctx.lineTo(pts[i].x, pts[i].y); ctx.strokeStyle = '#00d2ff'; ctx.lineWidth = 6; ctx.stroke(); }
    ctx.restore(); if(pts.length > 8) pts.shift();
}
function over(win, reason) {
    state.active = false; ui.panel.style.display = 'block';
    ui.title.innerText = win ? "é˜²å¾¡æˆåŠŸ" : "é˜²å¾¡å¤±è´¥"; ui.title.style.color = win ? "#27ae60" : "#c0392b";
    // ç™¼é€çµæœï¼šåŒ…å« maxCombo å’Œ totalTargets
    window.parent.postMessage({ type: 'GAME_OVER', win: win, reason: reason || "ç”Ÿå‘½å€¼è€—å°½", maxCombo: state.maxCombo, totalTargets: state.totalTargets }, '*');
}
function loop() {
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    if(state.active) {
        const passed = (Date.now() - state.start)/1000; const left = Math.max(0, CFG.gameTime - Math.floor(passed)); ui.time.innerText = left;
        if(passed >= CFG.safePhase && !state.phaseAlerted){ state.phaseAlerted = true; window.parent.postMessage({type: 'PHASE_CHANGE'}, '*'); }
        if(left <= 0) over(true, "ä»»åŠ¡å®Œæˆ");
    }
    for(let i=state.objs.length-1; i>=0; i--) {
        let obj = state.objs[i];
        if(obj.update()) { if(!obj.isTool && !obj.sliced) { takeDamage("æ¼æ‰äº†æ¶æ„æ”»å‡»"); } state.objs.splice(i,1); } else { obj.draw(); }
    }
    for(let i=state.parts.length-1; i>=0; i--) { state.parts[i].update(); if(state.parts[i].life<=0) state.parts.splice(i,1); else state.parts[i].draw(); }
    drawBlade(); animId = requestAnimationFrame(loop);
}
const events = { start: ['mousedown', 'touchstart'], move: ['mousemove', 'touchmove'], end: ['mouseup', 'touchend', 'mouseleave'] };
events.start.forEach(e => canvas.addEventListener(e, ev => { ev.preventDefault(); const p = ev.touches ? ev.touches[0] : ev; handleInput(p.clientX, p.clientY, true); }, {passive: false}));
events.move.forEach(e => canvas.addEventListener(e, ev => { ev.preventDefault(); if(state.blade.isDown) { const p = ev.touches ? ev.touches[0] : ev; handleInput(p.clientX, p.clientY, true); } }, {passive: false}));
events.end.forEach(e => canvas.addEventListener(e, ev => { ev.preventDefault(); handleInput(0, 0, false); }));
<\/script>
</body>
</html>
`;

        const gameState = { step: 0, typing: false };
        const els = {
            speaker: document.getElementById('speaker-name'),
            text: document.getElementById('text-box'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            startOverlay: document.getElementById('start-overlay'),
            charImg: document.getElementById('char-img'),
            vnLayers: document.getElementById('vn-layers'),
            gameWrapper: document.getElementById('game-stage-wrapper'),
            gameIframe: document.getElementById('game-iframe'),
            gameStartMask: document.getElementById('game-start-mask'),
            gameActionBtn: document.getElementById('btn-game-action'),
            miniChar: document.getElementById('mini-char-img'),
            miniText: document.getElementById('mini-text')
        };

        // --- åŠ‡æœ¬å…§å®¹ ---
        const script = [
            { speaker: 'SYSTEM', text: 'ã€ç³»çµ±æç¤ºã€‘ç”Ÿç‰©è­˜åˆ¥é€šéã€‚æ­£åœ¨å»ºç«‹åŠ å¯†é€šè¨Š...', image: null },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'çœ‹èµ·æ¥ä½ çŠ¶æ€ä¸é”™å˜›!', image: null },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ—©ä¸Šå¥½ï¼Œæ–°å…µã€‚æˆ‘æ˜¯ Evaï¼Œä½ çš„å…¥è·å¼•å°å“¡ã€‚', image: IMG_NORMAL },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ¥åˆ°è¿™é‡Œï¼Œå°±æ„å‘³è‘—ä½ å·²ç¶“å‡†å¤‡å¥½å…³äºã€Šç½‘ç»œå®‰å…¨ã€‹è€ƒæ ¸ï¼Œæˆä¸ºä¸€åç½‘ç»œæ‰§æ³•è€…äº†', image: IMG_NORMAL }, 
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'è€ƒæ ¸å†…å®¹åŒ…æ‹¬ä½†ä¸é™äº:ç—…æ¯’ç±»å‹,å¸¸è§çš„ç½‘ç»œæ”»å‡»æ‰‹æ®µä»¥åŠå¦‚ä½•é˜²èŒƒ,ç¤¾äº¤å·¥ç¨‹å­¦ç­‰ç­‰', image: IMG_NORMAL },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'è¶ç°åœ¨è€ƒæ ¸å®˜è¿˜æ²¡æ¥ï¼Œæˆ‘å…ˆè¯´å‡ ä¸ªå…³äºç¤¾äº¤å·¥ç¨‹æ¡ˆä¾‹', image: IMG_NORMAL },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ¡ˆä¾‹ä¸€ï¼šå› ä¸ºå…è´¹çš„ç¦åˆ©èµ„æºï¼Œè¿›å…¥é’“é±¼ç½‘ç«™ï¼Œæˆ‘ä»¬å‘ç°æ—¶ï¼Œè„‘æœºè¢«æ³¨å…¥äº†æœ¨é©¬ç¨‹åºï¼Œç°åœ¨è¿˜åœ¨åŒ»é™¢ï¼Œè¦çŸ¥é“ã€Šå…è´¹çš„æ‰æ˜¯æœ€è´µçš„ã€‹', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ¡ˆä¾‹äºŒï¼šå› ä¸ºä¸‹è½½ç¦åˆ©èµ„æºï¼Œå°±å…³é—­äº†é˜²ç«å¢™æˆ–è€…æ€æ¯’è½¯ä»¶ï¼Œäº²æ‰‹æŠŠé˜²çº¿å…¨éƒ¨è§£å¼€ï¼Œç°åœ¨å’Œä¸Šä¸€ä¸ªäººæ˜¯ç—…å‹', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æ¡ˆä¾‹ä¸‰ï¼šç”¨ä»»ä½•ä¸ªäººä¿¡æ¯åœ¨äº’è”ç½‘å’Œæ‰€è°“çš„â€œç¾å¥³â€äº¤æ¢è”ç³»æ–¹å¼ï¼Œç„¶åè„‘æœºæ¯ä¸€åˆ»éƒ½åœ¨æ”¶åˆ°åƒåœ¾é‚®ä»¶å’Œç”µä¿¡', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text:'å¸Œæœ›è¿™äº›äº‹æƒ…ä½ éƒ½æ²¡åšè¿‡,å“ˆå“ˆå“ˆ ', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'æˆ‘ä»¬æ¯æ—¶æ¯åˆ»éƒ½åœ¨ä¸ºç¾¤ä¼—å®£ä¼ ç½‘ç»œå®‰å…¨,ä½†æ˜¯ä¸æ³•åˆ†å­æ¯”æˆ‘ä»¬æ›´æ‡‚åº”ç”¨äººæ€§', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text:'æ‰€ä»¥å°±éœ€è¦æˆ‘ä»¬åœ¨äº’è”ç½‘ä¸Šç»´æŠ¤æ²»å®‰', image: IMG_RULES },
            { speaker: 'èŒ‰è‰(åŸ¹è¨“å®˜)', text: 'è¯´äº†è¿™ä¹ˆå¤šæ—¶é—´å·®ç‚¹è¿‡äº†å…³äº ç¤¾äº¤å·¥ç¨‹ çš„æ¡ˆä¾‹,å¸Œæœ›ä½ ä¸€ä¼šåœ¨è€ƒæ ¸ä¸­å°±ä¸è¦é”™äº†,ç°åœ¨è·³è½¬åˆ°#0375å°±å¯ä»¥å¼€å§‹è€ƒæ ¸äº†~', image: IMG_NORMAL },
            { speaker: 'SYSTEM', text: 'ã€éˆæ¥ä¸­æ–·ã€‘èŒ‰è‰ å·²ä¸‹ç·š,æ­£åœ¨é“¾æ¥#0375', image: null },
            { speaker: 'è¾­ç†’(è€ƒæ ¸å®˜)', text: 'ä¹…ç­‰äº†ï¼Œæˆ‘è´Ÿè´£çš„è€ƒæ ¸å†…å®¹æ˜¯ç½‘ç»œæ”»å‡»æ‰‹æ®µå’Œåº”å¯¹æ–¹æ³•', image: IMG_CIYING },
            { speaker: 'è¾­ç†’(è€ƒæ ¸å®˜)', text: 'ä½ éœ€è¦ç²¾å‡†åˆ†è¾¨ç—…æ¯’æˆ–æ”»å‡»æ‰‹æ®µï¼Œå°†ä»–ä»¬å…¨éƒ¨é“²é™¤ï¼Œé€”ä¸­æ³¨æ„ä¸è¦æ”»å‡»å‹å†›ï¼', image: IMG_CIYING },
            { type: 'GAME_PREPARE' }
        ];

        // --- é åŠ è¼‰åœ–ç‰‡ ---
        function preloadImages() {
            [IMG_NORMAL, IMG_RULES, IMG_CIYING].forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function initSystem() {
            preloadImages();
            els.startOverlay.style.opacity = '0';
            setTimeout(() => { els.startOverlay.style.display = 'none'; }, 500);
            renderStep();
        }

        function updateProgress() {
            const percentage = Math.floor(((gameState.step + 1) / script.length) * 100);
            els.progressBar.style.width = percentage + '%';
            els.progressText.innerText = percentage + '%';
        }

        function renderStep() {
            const currentScript = script[gameState.step];
            
            if (currentScript.type === 'GAME_PREPARE') {
                prepareMiniGame();
                return;
            }

            if (currentScript.image) {
                if (els.charImg.src !== currentScript.image) {
                    if (els.charImg.style.opacity === '1') {
                        els.charImg.style.opacity = '0';
                        setTimeout(() => {
                            els.charImg.src = currentScript.image;
                            els.charImg.style.opacity = '1';
                        }, 300);
                    } else {
                        els.charImg.src = currentScript.image;
                        setTimeout(() => els.charImg.style.opacity = '1', 50);
                    }
                } else {
                    els.charImg.style.opacity = '1';
                }
            } else {
                els.charImg.style.opacity = '0';
            }

            els.speaker.innerText = currentScript.speaker;
            els.speaker.style.background = currentScript.speaker.includes('SYSTEM') ? '#555' : 'var(--police-dark)';
            els.text.innerHTML = '';
            gameState.typing = true;
            let i = 0;
            const content = currentScript.text;
            
            function typeWriter() {
                if (i < content.length) {
                    els.text.innerHTML += content.charAt(i) === '\n' ? '<br>' : content.charAt(i);
                    i++;
                    setTimeout(typeWriter, 25);
                } else {
                    gameState.typing = false;
                }
            }
            typeWriter();
            updateProgress();
        }

        function nextStep() {
            if (gameState.typing) return;
            gameState.step++;
            if (gameState.step < script.length) {
                renderStep();
            } else {
                console.log("End of script");
            }
        }

        // --- éŠæˆ²ç›¸é—œé‚è¼¯ ---
        function prepareMiniGame() {
            els.vnLayers.style.opacity = '0';
            setTimeout(() => {
                els.vnLayers.style.display = 'none';
                els.gameWrapper.style.display = 'flex';
                els.miniChar.src = IMG_CIYING;
                els.gameIframe.srcdoc = GAME_SOURCE_CODE;
                
                els.gameStartMask.style.display = 'flex';
                els.gameActionBtn.innerText = "é–‹å§‹è€ƒæ ¸";
                
                updateMiniText("ç­‰å¾…è€ƒæ ¸é–‹å§‹...");
            }, 500);

            els.progressBar.style.width = '100%';
            els.progressText.innerText = 'è€ƒæ ¸æº–å‚™';
        }

        function triggerGameStart() {
            els.gameStartMask.style.display = 'none';
            const iframeWin = els.gameIframe.contentWindow;
            iframeWin.postMessage('START_GAME', '*');
            updateMiniText("å¸Œæœ›ä½ çœŸçš„åšå¥½äº†å‡†å¤‡");
        }

        function updateMiniText(text) {
            els.miniText.innerText = text;
        }

        // ç›£è½ iframe å‚³ä¾†çš„æ¶ˆæ¯
        window.addEventListener('message', function(e) {
            const data = e.data;
            if (!data.type) return;

            if (data.type === 'PHASE_CHANGE') {
                updateMiniText("ç°åœ¨å¼€å§‹å‡ºç°é˜²å¾¡æ‰‹æ®µäº†å“Ÿï¼Œæ³¨æ„æ•Œæˆ‘è¯†åˆ«");
            } 
            else if (data.type === 'GAME_OVER') {
                if (!data.win) {
                    // å¤±æ•—é‚è¼¯
                    updateMiniText(data.reason + "ï¼Œä½ éœ€è¦é‡æ–°å¼€å§‹è€ƒæ ¸");
                    setTimeout(() => {
                        els.gameStartMask.style.display = 'flex';
                        els.gameActionBtn.innerText = "é‡æ–°è€ƒæ ¸";
                    }, 500); 
                    
                } else {
                    // æˆåŠŸé‚è¼¯ï¼šå…ˆé¡¯ç¤ºæ–‡æœ¬
                    updateMiniText("è¡¨ç°ä¸é”™ï¼Œå¨èƒæ¸…é™¤");
                    
                    // 2ç§’å¾Œè·³è½‰å› VN æ¨¡å¼
                    setTimeout(() => {
                        // 1. éš±è—éŠæˆ²ï¼Œé¡¯ç¤ºå°è©±å±¤
                        els.gameWrapper.style.display = 'none';
                        els.vnLayers.style.display = 'block';
                        els.vnLayers.style.opacity = '1'; // ç¢ºä¿é€æ˜åº¦æ¢å¾©

                        // 2. åˆ¤æ–·æ˜¯å¦å®Œç¾é€šé—œ (é€£æ“Šæ•¸ = ç¸½ç›®æ¨™æ•¸)
                        const isPerfect = (data.maxCombo === data.totalTargets) && (data.totalTargets > 0);
                        const resultText = isPerfect 
                            ? "æ­å–œä½ å®Œç¾é€šè¿‡äº†æœ¬æ¬¡è€ƒæ ¸ï¼Œä½ å¯ä»¥å»æ‰¾ä¸‹ä¸€ä¸ªè€ƒå®˜äº†" 
                            : "ä¸”ç®—å·²é€šè¿‡çš„æœ¬æ¬¡è€ƒæ ¸ï¼Œä½ å¯ä»¥å»æ‰¾ä¸‹ä¸€ä¸ªè€ƒå®˜äº†";

                        // 3. å°‡æ–°çš„åŠ‡æœ¬æ’å…¥éšŠåˆ—ä¸¦åŸ·è¡Œ
                        // å› ç‚ºç•¶å‰ step åœåœ¨ GAME_PREPAREï¼Œæˆ‘å€‘ç›´æ¥è¿½åŠ æ–°å…§å®¹
                        script.push({ speaker: 'è¾­ç†’(è€ƒæ ¸å®˜)', text: resultText, image: IMG_CIYING });
                        script.push({ speaker: 'SYSTEM', text: 'æ­£åœ¨è·³è½¬#7098', image: null });

                        // 4. æ‰‹å‹•è§¸ç™¼ä¸‹ä¸€æ­¥
                        nextStep(); 

                    }, 2000);
                }
            }
        });
    </script>
</body>
</html>
